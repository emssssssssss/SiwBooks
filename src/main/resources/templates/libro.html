<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    <title th:text="${libro.titolo}">Dettaglio Libro</title>
    <link rel="stylesheet" th:href="@{/css/libro.css}">
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
</head>
<body>

    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <div class="libro-container">

        <h1 th:text="${libro.titolo}">Titolo Libro</h1>

        <div>
            <img th:src="${#lists.isEmpty(libro.immagini) ? '/images/default-cover.jpg' : libro.immagini[0]}"
                 th:alt="'Copertina di ' + ${libro.titolo}" />
        </div>

        <p><strong>Descrizione:</strong> <span th:text="${libro.descrizione}">Descrizione libro</span></p>
        <p><strong>Anno pubblicazione:</strong> <span th:text="${libro.annoPubblicazione}">Anno</span></p>
        <p><strong>Genere:</strong> <span th:text="${libro.genere}">Genere</span></p>

        <div th:if="${!#lists.isEmpty(libro.autori)}">
            <h3 th:text="${libro.autori.size() > 1 ? 'Autori' : 'Autore'}">Autore/i</h3>
            <ul>
                <li th:each="a : ${libro.autori}">
                    <a th:href="@{/autori/{id}(id=${a.id})}" th:text="${a.nome + ' ' + a.cognome}">Nome Autore</a>
                </li>
            </ul>
        </div>
        <div th:if="${#lists.isEmpty(libro.autori)}">
            <p><em>Nessun autore</em></p>
        </div>

        <div th:if="${libro.immagini.size() > 1}">
            <h3>Ulteriori immagini</h3>
            <div>
                <img th:each="img, iterStat : ${libro.immagini}" th:if="${iterStat.index > 0}"
                     th:src="${img}" th:alt="'Immagine aggiuntiva ' + ${iterStat.index}" style="max-width:150px; margin-right:10px;"/>
            </div>
        </div>

        <div th:if="${#authorization.expression('isAuthenticated()')}">
            <form th:action="@{/libro/{id}/letto(id=${libro.id})}" method="post" th:if="${!haGiaLetto}">
                <button type="submit">Segna come letto</button>
            </form>

            <form th:action="@{/libro/{id}/non-letto(id=${libro.id})}" method="post" th:if="${haGiaLetto}">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit" style="color: red;">Segna come non letto</button>
            </form>

            <p th:if="${haGiaLetto}" style="color: green;">Hai già letto questo libro.</p>
        </div>


            <!-- Tab: Recensioni -->
            <div id="recensioni" class="tab-content">
                <div th:if="${#lists.isEmpty(recensioni)}">
                    <em>Ancora nessuna recensione</em>
                </div>
                <div class="reviews-list" th:each="rec : ${recensioni}" th:unless="${#lists.isEmpty(recensioni)}">
                    <div class="review-card">
                        <h3 th:text="${rec.titolo}">Titolo recensione</h3>
                        <p>
                            <strong>Voto:</strong>
                            <span th:each="i : ${#numbers.sequence(1,5)}"
                                  th:text="${i <= rec.voto ? '★' : '☆'}"
                                  th:classappend="${i <= rec.voto ? 'full' : 'empty'}"
                                  class="star">★</span>
                            <span th:text="| (${rec.voto} / 5) |">(0/5)</span>
                        </p>
                        <p>
                            <strong>Autore:</strong>
                            <em>Utente anonimo</em>
                        </p>
                        <p th:text="${rec.testo}">Testo recensione</p>
                    </div>
                </div>
            </div>

        <!-- Azioni admin -->
        <div class="azioni-admin" sec:authorize="hasRole('ADMIN')" style="margin-top:20px;">
            <a th:href="@{/libri/modifica/{id}(id=${libro.id})}" class="btn-modifica">Modifica Libro</a>
            |
            <form th:action="@{/libri/elimina/{id}(id=${libro.id})}" method="post" style="display:inline;"
                  onsubmit="return confirm('Sei sicuro di voler eliminare questo libro?');">
                <button type="submit" class="btn-elimina">Elimina Libro</button>
            </form>
        </div>

    </div>

</body>
</html>
